<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>The HTTP part 3 - Parsing request &amp; response</title>
  <meta name="description" content="Previously we were looking at sockets, connections, TCP and Wireshark. This time, we will work on higher level stuff, there will be a lot of Kotlin code. But...">
  <link href='https://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,200,300' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Josefin+Sans:400,600,700,300' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/style.css">
  <link rel="canonical" href="http://localhost:4000/programming/http/server/kotlin/2018/09/03/http-part3.html">
  <link rel="alternate" type="application/rss+xml" title="Dyszkiewicz;" href="http://localhost:4000/feed.xml">

  <script src="/assets/js/cookies-eu-banner.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-32136566-8"></script>
</head>


  <body>

    
<div class="wrapper">
  <center> <a href="/index.html"><div class="site-title">   Dyszkiewicz; </div></a></center>
</div>
<div class="wrapper site-description">
<center>  Tech blog </center>
</div>
<div class="wrapper">
  <div class="trigger site-navigation">
    <a class="page-link" href="/index.html">HOME</a>

    
    

    <span class="exclamationMark">/</span><a class="page-link" href="/about/">About</a>
    
    
    
    
    
    
    
    
  </div>
</div>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline"><a class="post-title-link"  href="/programming/http/server/kotlin/2018/09/03/http-part3.html">The HTTP part 3 - Parsing request & response</a></h1>
  <center>  <p class="post-meta"><time datetime="2018-09-03T12:20:31+02:00" itemprop="datePublished">Sep 3, 2018</time></p>
    
   </center>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Previously we were looking at sockets, connections, TCP and Wireshark. This time, we will work on higher level stuff, there will be a lot of Kotlin code. But first…</p>

<h2 id="the-theory">The theory</h2>
<p>Let’s look at the anatomy of HTTP Request and HTTP Response</p>

<h3 id="http-request">HTTP Request</h3>
<p>From the <a href="https://tools.ietf.org/html/rfc2616#section-5">RFC2616</a> we can read that a request looks like this.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        Request       = Request-Line              ; Section 5.1
                        *(( general-header        ; Section 4.5
                         | request-header         ; Section 5.3
                         | entity-header ) CRLF)  ; Section 7.1
                        CRLF
                        [ message-body ]          ; Section 4.3

</code></pre></div></div>
<p>First, we’ve got mandatory <em>Request-Line</em>, then optional headers and after that - optional message body preceded by a mandatory newline character.</p>

<h4 id="request-line">Request Line</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		 Request-Line   = Method SP Request-URI SP HTTP-Version CRLF

       Method         = "OPTIONS"                ; Section 9.2
                      | "GET"                    ; Section 9.3
                      | "HEAD"                   ; Section 9.4
                      | "POST"                   ; Section 9.5
                      | "PUT"                    ; Section 9.6
                      | "DELETE"                 ; Section 9.7
                      | "TRACE"                  ; Section 9.8
                      | "CONNECT"                ; Section 9.9
                      | extension-method
       extension-method = token

       Request-URI    = "*" | absoluteURI | abs_path | authority
</code></pre></div></div>
<p><em>Request-Line</em> contains <em>Method</em>, <em>Request-URI</em> and <em>HTTP-Version</em> separated by spaces and ended by new line character. 
The method is one of the methods, you’ve probably encountered like <code class="highlighter-rouge">GET</code> or <code class="highlighter-rouge">POST</code>.</p>

<p><em>Request-URI</em> is the <code class="highlighter-rouge">/users/3</code> path in <code class="highlighter-rouge">http://localhost:8090/users/3</code> URL. Although we should support other options values like an absolute path or <code class="highlighter-rouge">*</code> for <code class="highlighter-rouge">OPTIONS</code> method, we will just use absolute paths.</p>

<p><em>HTTP-Version</em> is self-explanatory. Example values are <code class="highlighter-rouge">HTTP/1.0</code>, <code class="highlighter-rouge">HTTP1.1</code>. We will support <code class="highlighter-rouge">HTTP/1.1</code> for now.</p>

<p>Sample Request Line looks like this: <code class="highlighter-rouge">GET /users/3 HTTP/1.1</code></p>

<h4 id="request-headers">Request Headers</h4>
<p>Headers are key-value pairs of metadata of a request. They can be divided into 3 categories - General, Request, Entity. Luckily, it doesn’t matter in which order they are delivered from parsing perspective.</p>

<p>It’s worth to mention that a header key can have multiple values separated by commas. A sender should not send multiple pairs with the same key, but it can (<code class="highlighter-rouge">Set-Cookie</code> is a common exception) so we have to support it.</p>

<p>Sample headers look like this:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>accept: application/json
accept-encoding: gzip, deflate, br
accept-language: pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7
content-type: application/json
user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36
</code></pre></div></div>

<h4 id="about-header-case-sensitivity">About header case sensitivity</h4>
<p>Is <code class="highlighter-rouge">accept-language</code> and <code class="highlighter-rouge">Accept-Language</code> the same? Should two pairs of headers, one with lowercase, another with uppercase be merged into one?
According to <a href="https://tools.ietf.org/html/rfc2616#section-4.2">spec</a></p>
<blockquote>
  <p>Each header field consists of a name followed by a colon (“:”) and the field value. Field names are case-insensitive.</p>
</blockquote>

<p>I assume that the answers are: yes, they are the same and they should be merged.</p>

<p>What is more interesting, <a href="https://tools.ietf.org/html/rfc7540#section-8.1.2">HTTP/2.0 spec states</a></p>
<blockquote>
  <p>Just as in HTTP/1.x, header field names are strings of ASCII characters that are compared in a case-insensitive fashion. However, header field names MUST be converted to lowercase prior to their encoding in HTTP/2. A request or response containing uppercase header field names MUST be treated as malformed</p>
</blockquote>

<p>To avoid the confusion, we will keep our headers lowercase.</p>

<h4 id="sample-request">Sample Request</h4>
<p>Putting it all together - a sample request would look like this</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUT /users/3 HTTP/1.1
accept: application/json
accept-encoding: gzip, deflate, br
accept-language: pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7
content-type: application/json
user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36

{"name": "John"}
</code></pre></div></div>

<h3 id="http-response">HTTP Response</h3>
<p>Response structure looks similar to request, but instead of a <em>Request-Line</em>, there is a <em>Status-Line</em>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       Response      = Status-Line               ; Section 6.1
                       *(( general-header        ; Section 4.5
                        | response-header        ; Section 6.2
                        | entity-header ) CRLF)  ; Section 7.1
                       CRLF
                       [ message-body ]          ; Section 7.2

		 Status-Line = HTTP-Version SP Status-Code SP Reason-Phrase CRLF
</code></pre></div></div>

<h4 id="status-line">Status Line</h4>
<p>Status Line must contain <em>HTTP-Version</em>, <em>Status-Code</em> and <em>Reason-Phrase</em> divided by spaces and ended by new line character. Sample status line looks like this: <code class="highlighter-rouge">HTTP/1.1 200 OK</code></p>
<h4 id="sample-response">Sample response</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
accept-encoding: gzip, deflate, br
accept-language: pl-PL,pl;q=0.9,en-US;q=0.8,en;q=0.7
user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36

{"id": "123", "name": "John"}
</code></pre></div></div>

<p>Now we can move on to implementation.</p>
<h2 id="data-structures">Data structures</h2>
<p>To begin with, we define structures for request and response.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kd">val</span> <span class="py">PROTOCOL</span> <span class="p">=</span> <span class="s">"HTTP/1.1"</span>

<span class="kd">data class</span> <span class="nc">Request</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">path</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">method</span><span class="p">:</span> <span class="n">RequestMethod</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">headers</span><span class="p">:</span> <span class="n">HttpHeaders</span> <span class="p">=</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
        <span class="kd">val</span> <span class="py">body</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">Response</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">status</span><span class="p">:</span> <span class="n">Status</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">headers</span><span class="p">:</span> <span class="n">HttpHeaders</span> <span class="p">=</span> <span class="n">HttpHeaders</span><span class="p">(),</span>
        <span class="kd">val</span> <span class="py">body</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">RequestMethod</span> <span class="p">{</span>
    <span class="n">GET</span><span class="p">,</span>
    <span class="n">HEAD</span><span class="p">,</span>
    <span class="n">OPTIONS</span><span class="p">,</span>
    <span class="n">POST</span><span class="p">,</span>
    <span class="n">PUT</span><span class="p">,</span>
    <span class="n">DELETE</span><span class="p">,</span>
    <span class="n">TRACE</span><span class="p">,</span>
    <span class="n">CONNECT</span><span class="p">;</span>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="k">fun</span> <span class="nf">valueOfOrNull</span><span class="p">(</span><span class="nv">method</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">RequestMethod</span><span class="p">?</span> <span class="p">=</span> <span class="n">values</span><span class="p">().</span><span class="n">firstOrNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">name</span> <span class="p">==</span> <span class="n">method</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">Status</span><span class="p">(</span><span class="kd">val</span> <span class="py">code</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="kd">val</span> <span class="py">reason</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">OK</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s">"OK"</span><span class="p">),</span>
    <span class="n">BAD_REQUEST</span><span class="p">(</span><span class="m">400</span><span class="p">,</span> <span class="s">"Bad Request"</span><span class="p">),</span>
    <span class="n">INTERNAL_SERVER_ERROR</span><span class="p">(</span><span class="m">500</span><span class="p">,</span> <span class="s">"Internal Server Error"</span><span class="p">)</span>
    <span class="c1">// todo more status codes</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">HttpHeaders</span><span class="p">(</span><span class="nv">mapOfHeaders</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Collection</span><span class="err">&lt;</span><span class="nc">String</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="n">emptyMap</span><span class="p">())</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">mapOfHeaders</span><span class="p">:</span> <span class="n">Map</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Collection</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="n">mapOfHeaders</span><span class="p">.</span><span class="n">mapKeys</span> <span class="p">{</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">k</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">()</span> <span class="p">}</span> <span class="c1">//1</span>

    <span class="k">constructor</span><span class="p">(</span><span class="k">vararg</span> <span class="nv">pairs</span><span class="p">:</span> <span class="nc">Pair</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;)</span>
            <span class="p">:</span> <span class="nc">this</span><span class="p">(</span><span class="n">pairs</span><span class="p">.</span><span class="n">asSequence</span><span class="p">()</span>
            <span class="p">.</span><span class="n">groupBy</span> <span class="p">{</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">name</span> <span class="p">}</span> <span class="c1">// 2</span>
            <span class="p">.</span><span class="n">mapValues</span> <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">namesWithValues</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">namesWithValues</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">values</span> <span class="p">}</span> <span class="p">}</span>
            <span class="p">.</span><span class="n">toMap</span><span class="p">())</span>

    <span class="kd">val</span> <span class="py">size</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">mapOfHeaders</span><span class="p">.</span><span class="n">size</span>

    <span class="kd">val</span> <span class="py">contentLength</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="k">this</span><span class="p">[</span><span class="s">"content-length"</span><span class="p">].</span><span class="n">firstOrNull</span><span class="p">()</span><span class="o">?.</span><span class="n">toInt</span><span class="p">()</span> <span class="o">?:</span> <span class="m">0</span>

    <span class="k">fun</span> <span class="nf">asSequence</span><span class="p">()</span> <span class="p">=</span> <span class="n">mapOfHeaders</span><span class="p">.</span><span class="n">asSequence</span><span class="p">()</span>
    <span class="k">operator</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Collection</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">mapOfHeaders</span><span class="p">[</span><span class="n">key</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">()]</span> <span class="o">?:</span> <span class="n">emptyList</span><span class="p">()</span>
    <span class="k">operator</span> <span class="k">fun</span> <span class="nf">plus</span><span class="p">(</span><span class="nv">pair</span><span class="p">:</span> <span class="nc">Pair</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="n">HttpHeaders</span><span class="p">(</span><span class="n">mapOfHeaders</span> <span class="p">+</span> <span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span> <span class="n">to</span> <span class="n">listOf</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">)))</span>
<span class="p">}</span>

<span class="k">typealias</span> <span class="n">Handler</span> <span class="p">=</span> <span class="p">(</span><span class="n">Request</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Response</span>
</code></pre></div></div>

<p>Not much going on here. Just plain data classes and enums. Mind you that headers are not a simple list of key and value, because you can define multiple values for one key. Sadly, we still don’t have <a href="https://google.github.io/guava/releases/23.0/api/docs/com/google/common/collect/Multimap.html"><code class="highlighter-rouge">Multimap</code></a> data structure in JDK, nor in Kotlin standard library.
We lowercase every header (1) at the input of <code class="highlighter-rouge">HttpHeaders</code> class.
We also group headers (2) by name and convert to map in pair constructor so we can call it like this:
<code class="highlighter-rouge">HttpHeaders("content-type" to "application/json")</code> or <code class="highlighter-rouge">HttpHeaders("set-cookie", "a=x", "set-cookie", "b=y")</code></p>

<h2 id="request-parser">Request parser</h2>
<p>Let’s look at a code that is responsible for parsing a request</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kd">val</span> <span class="py">headerRegex</span> <span class="p">=</span> <span class="s">"^(.+): (.+)$"</span><span class="p">.</span><span class="n">toRegex</span><span class="p">()</span>
<span class="k">private</span> <span class="kd">val</span> <span class="py">requestLineRegex</span> <span class="p">=</span> <span class="s">"^(.+) (.+) (.+)$"</span><span class="p">.</span><span class="n">toRegex</span><span class="p">()</span>

<span class="kd">class</span> <span class="nc">RequestParseException</span><span class="p">(</span><span class="nv">msg</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">private</span> <span class="kd">data class</span> <span class="nc">RequestLine</span><span class="p">(</span><span class="kd">val</span> <span class="py">method</span><span class="p">:</span> <span class="n">RequestMethod</span><span class="p">,</span> <span class="kd">val</span> <span class="py">path</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="kd">val</span> <span class="py">protocol</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="k">fun</span> <span class="nc">Request</span><span class="p">.</span><span class="nc">Companion</span><span class="p">.</span><span class="nf">fromRaw</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="nc">BufferedReader</span><span class="p">):</span> <span class="nc">Request</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">requestLine</span> <span class="p">=</span> <span class="n">parseRequestLine</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">headers</span> <span class="p">=</span> <span class="n">parseHeaders</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="n">parseBody</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Request</span><span class="p">(</span><span class="n">requestLine</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">requestLine</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 3</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">parseRequestLine</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="nc">BufferedReader</span><span class="p">):</span> <span class="nc">RequestLine</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">requestLine</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="n">readLine</span><span class="p">()</span> <span class="o">?:</span> <span class="k">throw</span> <span class="n">RequestParseException</span><span class="p">(</span><span class="s">"Request must not be empty"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="p">(</span><span class="py">methodRaw</span><span class="p">,</span> <span class="py">path</span><span class="p">,</span> <span class="py">protocol</span><span class="p">)</span> <span class="p">=</span> <span class="n">requestLineRegex</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">requestLine</span><span class="p">)</span><span class="o">?.</span><span class="n">destructured</span>
            <span class="o">?:</span> <span class="k">throw</span> <span class="n">RequestParseException</span><span class="p">(</span><span class="s">"Invalid request line. It should match ${requestLineRegex.pattern} pattern"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">method</span> <span class="p">=</span> <span class="n">RequestMethod</span><span class="p">.</span><span class="n">valueOfOrNull</span><span class="p">(</span><span class="n">methodRaw</span><span class="p">)</span> <span class="o">?:</span> <span class="k">throw</span> <span class="n">RequestParseException</span><span class="p">(</span><span class="s">"Method $methodRaw is not supported"</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="p">!=</span> <span class="n">PROTOCOL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">RequestParseException</span><span class="p">(</span><span class="s">"Invalid protocol. Only $PROTOCOL is supported"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">RequestLine</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 4</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">parseHeaders</span><span class="p">(</span><span class="nv">input</span><span class="p">:</span> <span class="nc">BufferedReader</span><span class="p">):</span> <span class="nc">HttpHeaders</span> <span class="p">=</span>
        <span class="n">input</span><span class="p">.</span><span class="n">lineSequence</span><span class="p">()</span>
                <span class="p">.</span><span class="n">takeWhile</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">isNotBlank</span><span class="p">()</span> <span class="p">}</span>
                <span class="p">.</span><span class="n">map</span> <span class="p">{</span>
                    <span class="kd">val</span> <span class="p">(</span><span class="py">header</span><span class="p">,</span> <span class="py">values</span><span class="p">)</span> <span class="p">=</span> <span class="n">headerRegex</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">?.</span><span class="n">destructured</span>
                            <span class="o">?:</span> <span class="k">throw</span> <span class="n">RequestParseException</span><span class="p">(</span><span class="s">"Invalid header line: $it"</span><span class="p">)</span>
                    <span class="n">header</span> <span class="n">to</span> <span class="n">values</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">", "</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="p">.</span><span class="n">groupBy</span> <span class="p">{</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">name</span> <span class="p">}</span> <span class="c1">// 5</span>
                <span class="p">.</span><span class="n">mapValues</span> <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">valuesWithNames</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">valuesWithNames</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">values</span> <span class="p">}.</span><span class="n">flatten</span><span class="p">()</span> <span class="p">}</span>
                <span class="p">.</span><span class="n">let</span><span class="p">(</span><span class="o">::</span><span class="n">HttpHeaders</span><span class="p">)</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">parseBody</span><span class="p">(</span><span class="nv">headers</span><span class="p">:</span> <span class="nc">HttpHeaders</span><span class="p">,</span> <span class="nv">input</span><span class="p">:</span> <span class="nc">BufferedReader</span><span class="p">):</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span>
        <span class="k">when</span> <span class="p">{</span>
            <span class="n">headers</span><span class="p">.</span><span class="n">contentLength</span> <span class="p">==</span> <span class="m">0</span> <span class="p">-&gt;</span> <span class="k">null</span>
            <span class="k">else</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="kd">val</span> <span class="py">buffer</span> <span class="p">=</span> <span class="n">CharBuffer</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">headers</span><span class="p">.</span><span class="n">contentLength</span><span class="p">)</span>
                <span class="n">input</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
                <span class="n">buffer</span><span class="p">.</span><span class="n">flip</span><span class="p">()</span>
                <span class="n">buffer</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>Firstly, we parse a request line (3) validating method and protocol correctness.</p>

<p>Next, we parse headers (4). We can switch <code class="highlighter-rouge">BufferedReader</code> to <code class="highlighter-rouge">Sequence</code> by using built-in  <code class="highlighter-rouge">lineSequence()</code> extension function. Then we read lines one by one until the empty line that indicates a separation between headers and body. Then we map it to pairs of a header and its values keeping in mind that there can be multiple of those. A request may contain multiple headers with the same key, so we have to group it (5) by key and then flatten values to one collection. Finally, we create <code class="highlighter-rouge">HttpHeaders</code> instance from this map (map was created during grouping operation).</p>

<p>Parsing body is a tricky one. We cannot just read the rest of the stream, because reading is blocking until a connection is closed… which happens after sending response… which happens after reading request! We are in the loop! It turned out that we had to read as many bytes as sent in <code class="highlighter-rouge">Content-Length</code> header. That is not the end of the story. According to <a href="https://tools.ietf.org/html/rfc2616#section-4.4">RFC (4.4 Message Length)</a> there are also other ways ( <code class="highlighter-rouge">chunked</code> transfer encoding, multipart files) of sending body, but we will keep it simple for now.</p>

<p>You could start to worry. What if someone sends <code class="highlighter-rouge">Content-Length</code>, but <em>forget</em> to send a body? Now we are waiting for a body as long as a connection is up. What about a gigantic body of <code class="highlighter-rouge">Integer.MAX_VALUE</code> size (~2GB, if you were wondering)? This is a problem, but we didn’t want to get into <em>things going wrong</em>, we will get back to it later when we will implement a connection pool with timeouts.</p>

<p>Another thing is that we immediately read a body of a request. Maybe we don’t need to do that, because our <code class="highlighter-rouge">Handler</code> won’t use it?</p>

<p>I’m sure there are a lot of more caveats, but let’s code that iteratively -  you know… The Agile Way!</p>

<h2 id="generate-response">Generate response</h2>
<p>Generating response is simpler because we already have structured data.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">const</span> <span class="kd">val</span> <span class="py">HEADERS_BODY_SEPARATOR</span> <span class="p">=</span> <span class="s">"\n"</span>

<span class="k">fun</span> <span class="nc">Response</span><span class="p">.</span><span class="nf">toRaw</span><span class="p">():</span> <span class="nc">String</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">buffer</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
    <span class="n">appendStatusLine</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">appendRawHeaders</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
    <span class="n">body</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">HEADERS_BODY_SEPARATOR</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">buffer</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nc">Response</span><span class="p">.</span><span class="nf">appendRawHeaders</span><span class="p">(</span><span class="nv">buffer</span><span class="p">:</span> <span class="nc">StringBuffer</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">headers</span><span class="p">.</span><span class="n">asSequence</span><span class="p">()</span>
            <span class="p">.</span><span class="n">joinTo</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="s">"$name: ${values.joinToString("</span><span class="p">,</span> <span class="s">")}\n"</span>
            <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nc">Response</span><span class="p">.</span><span class="nf">appendStatusLine</span><span class="p">(</span><span class="nv">buffer</span><span class="p">:</span> <span class="nc">StringBuffer</span><span class="p">)</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"$PROTOCOL ${status.code} ${status.reason}\n"</span><span class="p">)</span>
</code></pre></div></div>

<p>Firstly, we generate a status line which contains a protocol, a status code, and a status reason. Then we append headers and after that, if body exists we append it after a new line which is a separator.</p>

<p>We could probably make it more performant by writing directly to <code class="highlighter-rouge">BufferedWriter</code> but let’s leave it as it is for simplicity.</p>

<h2 id="putting-it-all-together">Putting it all together</h2>
<p>Now we have to use it in our server.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Server</span><span class="p">(</span>
        <span class="kd">val</span> <span class="py">handler</span><span class="p">:</span> <span class="n">Handler</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">port</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
        <span class="kd">val</span> <span class="py">maxIncomingConnections</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">1</span>
<span class="p">):</span> <span class="nc">AutoCloseable</span> <span class="p">{</span>

   <span class="o">..</span><span class="p">.</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleConnection</span><span class="p">(</span><span class="nv">socket</span><span class="p">:</span> <span class="nc">Socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">input</span> <span class="p">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">().</span><span class="n">bufferedReader</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">output</span> <span class="p">=</span> <span class="n">PrintWriter</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">())</span>

        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="k">try</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">Request</span><span class="p">.</span><span class="n">fromRaw</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nv">e</span><span class="p">:</span> <span class="nc">RequestParseException</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Response</span><span class="p">(</span><span class="n">status</span> <span class="p">=</span> <span class="n">Status</span><span class="p">.</span><span class="n">BAD_REQUEST</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">output</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">toRaw</span><span class="p">())</span>
        <span class="n">output</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div></div>
<p>We now pass <code class="highlighter-rouge">Handler</code> (a function from <code class="highlighter-rouge">Request</code> to <code class="highlighter-rouge">Response</code>) that tells a server how it should respond for a request.  We parse the request, pass it to <code class="highlighter-rouge">Handler</code> and then generate a raw response from its return value that we write to a socket.</p>

<p>We should actually return 505 (HTTP Version Not supported) and 405 (Method Not Allowed) and other statuses but let’s leave it for now and get back to nicer exception handling later when we code server filters.</p>

<h3 id="echo-did-you-hear-me">Echo! Did you hear me?</h3>
<p>The simplest test for our new code is to send a request to a server with body and headers and receive it back.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
    <span class="k">fun</span> <span class="err">`</span><span class="nf">server</span> <span class="n">should</span> <span class="n">echo</span> <span class="n">body</span> <span class="n">and</span> <span class="n">headers</span><span class="err">`</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// given</span>
        <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="s">"Echo!"</span>
        <span class="kd">val</span> <span class="py">server</span> <span class="p">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">port</span> <span class="p">=</span> <span class="m">8090</span><span class="p">,</span> <span class="n">maxIncomingConnections</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">handler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
            <span class="n">Response</span><span class="p">(</span>
                    <span class="n">status</span> <span class="p">=</span> <span class="n">Status</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span>
                    <span class="n">body</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">body</span><span class="p">,</span>
                    <span class="n">headers</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="c1">// when</span>
        <span class="kd">val</span> <span class="py">connection</span> <span class="p">=</span> <span class="n">URL</span><span class="p">(</span><span class="s">"http://localhost:8090/"</span><span class="p">).</span><span class="n">openConnection</span><span class="p">()</span> <span class="k">as</span> <span class="n">HttpURLConnection</span>
        <span class="n">connection</span><span class="p">.</span><span class="n">run</span> <span class="p">{</span>
            <span class="n">connectTimeout</span> <span class="p">=</span> <span class="m">50</span>
            <span class="n">requestMethod</span> <span class="p">=</span> <span class="s">"POST"</span>
            <span class="n">setRequestProperty</span><span class="p">(</span><span class="s">"X-Custom-Header"</span><span class="p">,</span> <span class="s">"ABC"</span><span class="p">)</span>
            <span class="n">setFixedLengthStreamingMode</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
            <span class="n">doOutput</span> <span class="p">=</span> <span class="k">true</span>
            <span class="n">connect</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="kd">val</span> <span class="py">writer</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">outputStream</span><span class="p">.</span><span class="n">bufferedWriter</span><span class="p">()</span>
        <span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">writer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">responseCode</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">responseCode</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">inputStream</span><span class="p">.</span><span class="n">bufferedReader</span><span class="p">().</span><span class="n">readText</span><span class="p">()</span>
        <span class="n">connection</span><span class="p">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="c1">// then</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">responseCode</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">200</span><span class="p">)</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">"Echo!"</span><span class="p">)</span>
        <span class="n">assertThat</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="n">getHeaderField</span><span class="p">(</span><span class="s">"X-Custom-Header"</span><span class="p">)).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">"ABC"</span><span class="p">)</span>

        <span class="c1">// cleanup</span>
        <span class="n">server</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>We run it and the test passes, we sent post method with header and get it back with 200 OK response. Sweet!</p>

<h2 id="one-more-thing---facade-over-httpurlconnection">One more thing - Facade over HttpURLConnection</h2>
<p>Let’s do one more thing. I don’t really like the API of HttpURLConnection. As you probably noticed in the last listing there is a lot of boilerplate code to send a request. We should build a simple <a href="https://en.wikipedia.org/wiki/Facade_pattern">facade</a> over <code class="highlighter-rouge">HttpUrlConnection</code> using our data structures. We can create an interface.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>interface Client {
    fun exchange(url: String, request: Request): Response
}
</code></pre></div></div>

<p>Then we can refactor our last when section to</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// when</span>
<span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">exchange</span><span class="p">(</span>
        <span class="n">url</span> <span class="p">=</span> <span class="s">"http://localhost:8090"</span><span class="p">,</span>
        <span class="n">request</span> <span class="p">=</span> <span class="n">Request</span><span class="p">(</span>
                <span class="n">path</span> <span class="p">=</span> <span class="s">"/"</span><span class="p">,</span>
                <span class="n">method</span> <span class="p">=</span> <span class="n">POST</span><span class="p">,</span>
                <span class="n">headers</span> <span class="p">=</span> <span class="n">HttpHeaders</span><span class="p">(</span><span class="s">"X-Custom-Header"</span> <span class="n">to</span> <span class="s">"ABC"</span><span class="p">),</span>
                <span class="n">body</span> <span class="p">=</span> <span class="n">body</span><span class="p">))</span>
</code></pre></div></div>

<p>This is a much nicer code in my opinion. Why don’t we use something already made like Spring’s <code class="highlighter-rouge">RestTemplate</code> or <code class="highlighter-rouge">Retrofit</code>? Because we will write our own client eventually, so we will already have an interface that we can code to and we can switch to it with minimal effort.</p>

<p>If you are interested in facade implementation you can check it out <a href="https://github.com/jakubdyszkiewicz/naphi/blob/http-3-parsing-request-response/src/main/kotlin/org/naphi/Client.kt">here</a>.</p>

<h2 id="summary--whats-next">Summary &amp; What’s next?</h2>
<p>We managed to successfully (although definitely not RFC compliant) parse a request and generate a response. We now can return something other than <code class="highlighter-rouge">Hello, World!</code> , we can now for example test slow sending response without changing our server code.</p>

<p>Next up we will tackle multithreading!</p>

<h1 id="other-articles-of-the-series">Other articles of the series</h1>
<p>This article is a part of the HTTP series</p>
<ul>
  
    <li>
        
            <a href="/programming/http/server/kotlin/2018/11/01/http-part6.html">The HTTP part 6 - HTTP Client</a>
        
    </li>
  
    <li>
        
            <a href="/programming/http/server/kotlin/2018/10/09/http-part5.html">The HTTP part 5 - Persistent connections</a>
        
    </li>
  
    <li>
        
            <a href="/programming/http/server/kotlin/2018/09/09/http-part4.html">The HTTP part 4 - Multithreading</a>
        
    </li>
  
    <li>
        
            The HTTP part 3 - Parsing request &amp; response
        
    </li>
  
    <li>
        
            <a href="/programming/http/server/kotlin/2018/08/11/http-part2.html">The HTTP part 2 - Connections Queue</a>
        
    </li>
  
    <li>
        
            <a href="/programming/http/server/kotlin/2018/07/31/http-part1.html">The HTTP part 1 - Let's start small</a>
        
    </li>
  
</ul>

  </div>

  
  <div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//dyszkiewicz.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading small-site-title">Dyszkiewicz;</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list footer-content">
          <li>Based on <a href="http://github.com/hemangsk/Gravity">Gravity</a></li>
          <li>Made with <i class="fa fa-heart"></i> on <a href="jekyll.com"><span style="color:black">Jekyll</a></span></li>


        </ul>
      </div>

      <div class="footer-col footer-col-2 footer-content">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jakubdyszkiewicz"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jakubdyszkiewicz</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jdyszkiewicz"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jdyszkiewicz</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3 site-description">
        <!-- <p>Tech blog</p> -->
      </div>
    </div>

    <div id="cookies-eu-banner" style="display: none;">
      This site uses cookies to collect visits statistics via Google Analytics
      <!-- By continuing your visit to this site, you accept the use of cookies by Google Analytics to make visits statistics. -->
      <a href="https://policies.google.com/technologies/cookies" target="_blank" id="cookies-eu-more" class="cookies-eu-more-link">Read more</a>
      <!-- <button id="cookies-eu-reject">No</button> -->
      <button id="cookies-eu-accept">OK</button>
    </div>

    <script>
      new CookiesEuBanner(function(){
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-32136566-8');
      }, true);
    </script>
  </div>


</footer>


  </body>

</html>
